name: Test

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
        working-directory: ./example
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter SDK
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.22.2

      - name: Run pub get
        run: flutter pub get

      - name: Launch iOS Simulator
        run: |
          export SIMULATOR_UUID=$(xcrun simctl list devices "iOS 18.3" | grep "iPhone 16" | grep -m 1 -E -o -i "([0-9a-f]{8}-([0-9a-f]{4}-){3}[0-9a-f]{12})") 
          xcrun simctl boot $SIMULATOR_UUID
          echo "SIMULATOR_UUID=${SIMULATOR_UUID}" >> $GITHUB_ENV

      - name: Run Integration Tests
        run: flutter test integration_test --device-id="${SIMULATOR_UUID}"
